// KlixGenix.ID Extension - Complete App Data Synchronized with Website

// Premium Apps (71 apps) - Core subscription tier
const premiumApps = [
  {
    id: "chatgpt",
    name: "ChatGPT",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1746611969622.png",
    category: "ai",
    url: "https://chat.openai.com",
    description: "AI assistant premium",
    plan: "premium",
  },
  {
    id: "netflix",
    name: "Netflix",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1746611849606.png",
    category: "streaming",
    url: "https://netflix.com",
    description: "Film dan series premium",
    plan: "premium",
  },
  {
    id: "prime-video",
    name: "Prime Video",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1746612054926.png",
    category: "streaming",
    url: "https://primevideo.com",
    description: "Amazon streaming service",
    plan: "premium",
  },
  {
    id: "canva",
    name: "Canva",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1747072394897.png",
    category: "design",
    url: "https://canva.com",
    description: "Design tool online premium",
    plan: "premium",
  },
  {
    id: "grammarly",
    name: "Grammarly",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331265501.png",
    category: "writing",
    url: "https://grammarly.com",
    description: "Grammar checker premium",
    plan: "premium",
  },
  {
    id: "youtube-premium",
    name: "YouTube Premium",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730641254123.png",
    category: "streaming",
    url: "https://youtube.com",
    description: "Ad-free YouTube experience",
    plan: "premium",
  },
  {
    id: "turnitin",
    name: "Turnitin",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331054170.png",
    category: "education",
    url: "https://turnitin.com",
    description: "Plagiarism checker",
    plan: "premium",
  },
  {
    id: "quillbot",
    name: "QuillBot",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331083847.png",
    category: "writing",
    url: "https://quillbot.com",
    description: "Paraphrasing tool premium",
    plan: "premium",
  },
  {
    id: "perplexity",
    name: "Perplexity",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331118569.png",
    category: "ai",
    url: "https://perplexity.ai",
    description: "AI search engine",
    plan: "premium",
  },
  {
    id: "deepl",
    name: "DeepL",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331534749.png",
    category: "language",
    url: "https://deepl.com",
    description: "Advanced language translator",
    plan: "premium",
  },
  {
    id: "crunchyroll",
    name: "Crunchyroll",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1746612117525.png",
    category: "streaming",
    url: "https://crunchyroll.com",
    description: "Anime streaming platform",
    plan: "premium",
  },
  {
    id: "envato-elements",
    name: "Envato Elements",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331061271.png",
    category: "design",
    url: "https://elements.envato.com",
    description: "Design assets unlimited",
    plan: "premium",
  },
  {
    id: "viu",
    name: "Viu",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331067913.png",
    category: "streaming",
    url: "https://viu.com",
    description: "Asian drama streaming",
    plan: "premium",
  },
  {
    id: "scribd",
    name: "Scribd",
    icon: "📚",
    category: "education",
    url: "https://scribd.com",
    description: "Digital library unlimited",
    plan: "premium",
  },
  {
    id: "freepik",
    name: "Freepik",
    icon: "🎨",
    category: "design",
    url: "https://freepik.com",
    description: "Premium design resources",
    plan: "premium",
  },
  {
    id: "epidemic-sound",
    name: "Epidemic Sound",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331436616.png",
    category: "audio",
    url: "https://epidemicsound.com",
    description: "Royalty-free music library",
    plan: "premium",
  },
  {
    id: "capcut",
    name: "CapCut",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331130077.png",
    category: "video",
    url: "https://capcut.com",
    description: "Video editing online",
    plan: "premium",
  },
  {
    id: "bstation",
    name: "Bstation",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1745323394943.png",
    category: "streaming",
    url: "https://bstation.com",
    description: "Bilibili streaming",
    plan: "premium",
  },
  {
    id: "everand",
    name: "Everand",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331186085.png",
    category: "education",
    url: "https://everand.com",
    description: "Ebooks dan audiobooks",
    plan: "premium",
  },
  {
    id: "slideshare",
    name: "Slideshare",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331200277.png",
    category: "education",
    url: "https://slideshare.net",
    description: "Presentation sharing platform",
    plan: "premium",
  },
  {
    id: "scholarcy",
    name: "Scholarcy",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331211227.png",
    category: "research",
    url: "https://scholarcy.com",
    description: "Research paper summarizer",
    plan: "premium",
  },
  {
    id: "wetv",
    name: "WeTV",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331247021.png",
    category: "streaming",
    url: "https://wetv.vip",
    description: "Chinese drama streaming",
    plan: "premium",
  },
  {
    id: "iflix",
    name: "iflix",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331360016.png",
    category: "streaming",
    url: "https://iflix.com",
    description: "Southeast Asia streaming",
    plan: "premium",
  },
  {
    id: "academia-edu",
    name: "Academia.edu",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331277249.png",
    category: "education",
    url: "https://academia.edu",
    description: "Academic research platform",
    plan: "premium",
  },
  {
    id: "iloveimg",
    name: "iLoveIMG",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1747077032124.png",
    category: "design",
    url: "https://iloveimg.com",
    description: "Image editing tools",
    plan: "premium",
  },
  {
    id: "ilovepdf",
    name: "iLovePDF",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1747077018950.png",
    category: "design",
    url: "https://ilovepdf.com",
    description: "PDF editing tools",
    plan: "premium",
  },
  {
    id: "duolingo",
    name: "Duolingo",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331338823.png",
    category: "language",
    url: "https://duolingo.com",
    description: "Language learning premium",
    plan: "premium",
  },
  {
    id: "flaticon",
    name: "Flaticon",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1736840945897.png",
    category: "design",
    url: "https://flaticon.com",
    description: "Icon library premium",
    plan: "premium",
  },
  {
    id: "coursera",
    name: "Coursera",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331424928.png",
    category: "education",
    url: "https://coursera.org",
    description: "Online course platform",
    plan: "premium",
  },
  {
    id: "semrush",
    name: "Semrush",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1732257003678.png",
    category: "research",
    url: "https://semrush.com",
    description: "SEO & marketing toolkit",
    plan: "premium",
  },
  {
    id: "hbo-max",
    name: "HBO Max",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1745323279912.png",
    category: "streaming",
    url: "https://hbomax.com",
    description: "HBO premium content",
    plan: "premium",
  },
];

// Exclusive Apps (13 apps) - Premium + Exclusive tier
const exclusiveApps = [
  {
    id: "exclusive-netflix",
    name: "Exclusive Netflix",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1742276395218.png",
    category: "streaming",
    url: "https://netflix.com",
    description: "Netflix dengan akses khusus",
    plan: "exclusive",
  },
  {
    id: "exclusive-chatgpt-plus",
    name: "Exclusive ChatGPT Plus",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1742972212659.png",
    category: "ai",
    url: "https://chat.openai.com",
    description: "ChatGPT Plus eksklusif",
    plan: "exclusive",
  },
  {
    id: "exclusive-chatgpt-pro",
    name: "Exclusive ChatGPT PRO",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1742277395672.png",
    category: "ai",
    url: "https://chat.openai.com",
    description: "ChatGPT PRO akses khusus",
    plan: "exclusive",
  },
  {
    id: "exclusive-bein-sports",
    name: "Exclusive beIN Sports",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1742972235931.png",
    category: "streaming",
    url: "https://beinsports.com",
    description: "beIN Sports premium access",
    plan: "exclusive",
  },
  {
    id: "exclusive-disney-hotstar",
    name: "Exclusive Disney+ Hotstar",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1742272953621.png",
    category: "streaming",
    url: "https://hotstar.com",
    description: "Disney+ Hotstar eksklusif",
    plan: "exclusive",
  },
  {
    id: "exclusive-vidio",
    name: "Exclusive Vidio.com",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1742273215456.png",
    category: "streaming",
    url: "https://vidio.com",
    description: "Vidio.com premium access",
    plan: "exclusive",
  },
  {
    id: "exclusive-perplexity",
    name: "Exclusive Perplexity",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1742273033964.png",
    category: "ai",
    url: "https://perplexity.ai",
    description: "Perplexity AI eksklusif",
    plan: "exclusive",
  },
  {
    id: "exclusive-coohom",
    name: "Exclusive Coohom",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1742272886137.png",
    category: "design",
    url: "https://coohom.com",
    description: "Coohom design platform",
    plan: "exclusive",
  },
  {
    id: "exclusive-sora-pro",
    name: "Exclusive Sora Pro",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1742273203148.png",
    category: "ai",
    url: "https://sora.openai.com",
    description: "Sora Pro video generation",
    plan: "exclusive",
  },
  {
    id: "exclusive-sora-plus",
    name: "Exclusive Sora Plus",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1742273100681.png",
    category: "ai",
    url: "https://sora.openai.com",
    description: "Sora Plus premium access",
    plan: "exclusive",
  },
  {
    id: "exclusive-blackbox-ai",
    name: "Exclusive Blackbox AI",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1747729192193.png",
    category: "ai",
    url: "https://blackbox.ai",
    description: "Blackbox AI coding assistant",
    plan: "exclusive",
  },
  {
    id: "exclusive-trae-ai",
    name: "Exclusive Trae AI",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1749527372782.png",
    category: "ai",
    url: "https://trae.ai",
    description: "Trae AI platform eksklusif",
    plan: "exclusive",
  },
  {
    id: "exclusive-cursor-ai",
    name: "Exclusive Cursor AI",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1749553775737.png",
    category: "development",
    url: "https://cursor.sh",
    description: "Cursor AI code editor",
    plan: "exclusive",
  },
];

// Education Apps (46 apps) - Student-focused tier
const educationApps = [
  {
    id: "edu-scribd",
    name: "Scribd",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331170322.png",
    category: "education",
    url: "https://scribd.com",
    description: "Digital library unlimited",
    plan: "education",
  },
  {
    id: "edu-coursera",
    name: "Coursera",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331424928.png",
    category: "education",
    url: "https://coursera.org",
    description: "Online course platform",
    plan: "education",
  },
  {
    id: "edu-skillshare",
    name: "Skillshare",
    icon: "🎓",
    category: "education",
    url: "https://skillshare.com",
    description: "Creative learning platform",
    plan: "education",
  },
  {
    id: "edu-duolingo",
    name: "Duolingo",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331338823.png",
    category: "language",
    url: "https://duolingo.com",
    description: "Language learning premium",
    plan: "education",
  },
  {
    id: "edu-everand",
    name: "Everand",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331186085.png",
    category: "education",
    url: "https://everand.com",
    description: "Ebooks dan audiobooks",
    plan: "education",
  },
  {
    id: "edu-slideshare",
    name: "Slideshare",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331200277.png",
    category: "education",
    url: "https://slideshare.net",
    description: "Presentation sharing platform",
    plan: "education",
  },
  {
    id: "edu-scholarcy",
    name: "Scholarcy",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1730331211227.png",
    category: "research",
    url: "https://scholarcy.com",
    description: "Research paper summarizer",
    plan: "education",
  },
  {
    id: "edu-busuu",
    name: "Busuu",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1745323415059.png",
    category: "language",
    url: "https://busuu.com",
    description: "Language learning platform",
    plan: "education",
  },
  {
    id: "edu-scite-ai",
    name: "Scite AI",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1732257044432.png",
    category: "research",
    url: "https://scite.ai",
    description: "Smart citation analysis",
    plan: "education",
  },
  {
    id: "edu-scispace",
    name: "SciSpace",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1731051815321.png",
    category: "research",
    url: "https://scispace.com",
    description: "Scientific research tool",
    plan: "education",
  },
  {
    id: "edu-consensus",
    name: "Consensus",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1732204515132.png",
    category: "research",
    url: "https://consensus.app",
    description: "Scientific search engine",
    plan: "education",
  },
  {
    id: "edu-gamma",
    name: "Gamma",
    icon: "https://cdn.premiumportal.id/be/uploads/types/type-1732610563803.jpg",
    category: "design",
    url: "https://gamma.app",
    description: "AI presentation maker",
    plan: "education",
  },
];

// Storage data
let recentApps = [];
let favorites = [];
let currentTab = "apps";
let currentCategory = "all";

// User data and authentication
let userPlan = null;
let userAuthenticated = false;

// DOM ready
document.addEventListener("DOMContentLoaded", async () => {
  // Initialize components first
  initializeTabs();
  initializeCategories();
  initializeSearch();

  // Load data and authenticate
  await loadStorageData();
  await checkUserAuthentication();

  // Render initial state
  renderApps();
  updateStats();

  // Hide loading screen with optimized timing
  setTimeout(() => {
    const loading = document.getElementById("loading");
    const mainContent = document.getElementById("main-content");

    loading.style.opacity = "0";
    loading.style.transition = "opacity 0.4s ease-out";

    setTimeout(() => {
      loading.style.display = "none";
      mainContent.classList.remove("hidden");
    }, 400);
  }, 1000);

  // Footer buttons
  document.getElementById("dashboard-btn").addEventListener("click", () => {
    chrome.tabs.create({ url: "https://klixgenix.id/dashboard" });
    window.close();
  });

  document.getElementById("whatsapp-btn").addEventListener("click", () => {
    openWhatsAppSupport();
  });

  document.getElementById("settings-btn").addEventListener("click", () => {
    chrome.tabs.create({ url: "https://klixgenix.id/profile/edit" });
    window.close();
  });

  // WhatsApp Floating Action Button
  document.getElementById("whatsapp-fab").addEventListener("click", () => {
    openWhatsAppSupport();
  });

  // Update uptime every minute
  setInterval(calculateAndDisplayUptime, 60000);
});

// Initialize tabs
function initializeTabs() {
  const tabs = document.querySelectorAll(".tab");
  tabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      const tabName = tab.dataset.tab;
      switchTab(tabName);
    });
  });
}

// Switch tab
function switchTab(tabName) {
  currentTab = tabName;

  // Update tab buttons
  document.querySelectorAll(".tab").forEach((tab) => {
    tab.classList.toggle("active", tab.dataset.tab === tabName);
  });

  // Update content
  document.querySelectorAll(".tab-content").forEach((content) => {
    content.classList.toggle("active", content.id === `${tabName}-content`);
  });

  // Render content based on tab
  switch (tabName) {
    case "apps":
      renderApps();
      break;
    case "recent":
      renderRecentApps();
      break;
    case "favorites":
      renderFavoriteApps();
      break;
  }
}

// Initialize categories
function initializeCategories() {
  const categoryBtns = document.querySelectorAll(".category-btn");
  categoryBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      currentCategory = btn.dataset.category;
      categoryBtns.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");
      renderApps();
    });
  });
}

// Initialize search
function initializeSearch() {
  const searchInput = document.getElementById("search-input");
  searchInput.addEventListener("input", renderApps);
}

// Get apps based on user plan
function getAvailableApps() {
  if (!userAuthenticated) {
    return [];
  }

  switch (userPlan) {
    case "premium":
      return premiumApps;
    case "education":
      // Education plan gets selected premium apps + education-specific apps
      const educationRelevantApps = premiumApps.filter((app) =>
        [
          "ai",
          "writing",
          "education",
          "language",
          "design",
          "research",
        ].includes(app.category),
      );
      return [...educationRelevantApps, ...educationApps];
    case "exclusive":
      return [...premiumApps, ...exclusiveApps];
    default:
      return premiumApps; // fallback to premium
  }
}

// Check user authentication and plan
async function checkUserAuthentication() {
  try {
    // Try to get authentication from website cookies
    const result = await chrome.storage.local.get(["userAuth", "userPlan"]);

    if (result.userAuth && result.userPlan) {
      userAuthenticated = true;
      userPlan = result.userPlan;
      return;
    }

    // Check if user is logged in by sending message to background script
    chrome.runtime.sendMessage({ type: "checkAuth" }, (response) => {
      if (response && response.authenticated) {
        userAuthenticated = true;
        userPlan = response.plan || "premium";
        chrome.storage.local.set({ userAuth: true, userPlan: userPlan });
        // Refresh UI after authentication
        renderApps();
        updateStats();
        updatePlanBadge(userPlan);
      } else {
        // Demo mode fallback - show premium plan for testing
        userAuthenticated = true;
        userPlan = "premium";
        chrome.storage.local.set({ userAuth: true, userPlan: userPlan });
        renderApps();
        updateStats();
        updatePlanBadge(userPlan);
      }
    });
  } catch (error) {
    console.log("Authentication check failed, using demo mode:", error);
    // Fallback to demo mode
    userAuthenticated = true;
    userPlan = "premium";
    chrome.storage.local.set({ userAuth: true, userPlan: userPlan });
  }
}

// Render apps
function renderApps() {
  const grid = document.getElementById("apps-grid");
  const searchTerm = document
    .getElementById("search-input")
    .value.toLowerCase();

  if (!userAuthenticated) {
    grid.innerHTML = `
      <div class="auth-required">
        <div class="empty-state-icon">🔒</div>
        <h3>Login Required</h3>
        <p>Please login to KlixGenix.ID to access premium apps and enjoy seamless integration.</p>
        <button onclick="chrome.tabs.create({url: 'https://klixgenix.id/login'}); window.close();">
          Login to KlixGenix.ID
        </button>
      </div>
    `;
    return;
  }

  let availableApps = getAvailableApps();

  // Filter by category
  if (currentCategory !== "all") {
    availableApps = availableApps.filter(
      (app) => app.category === currentCategory,
    );
  }

  // Filter by search
  if (searchTerm) {
    availableApps = availableApps.filter(
      (app) =>
        app.name.toLowerCase().includes(searchTerm) ||
        app.description.toLowerCase().includes(searchTerm),
    );
  }

  if (availableApps.length === 0) {
    grid.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">🔍</div>
        <h3>No apps found</h3>
        <p>Try adjusting your search terms or selecting a different category to find more apps.</p>
      </div>
    `;
    return;
  }

  grid.innerHTML = availableApps
    .map(
      (app) => `
      <div class="app-item ${app.plan === "exclusive" ? "exclusive-app" : ""}" data-app-id="${app.id}">
        <div class="app-icon-container">
          ${
            app.icon.startsWith("http")
              ? `<img src="${app.icon}"
                 alt="${app.name}"
                 class="app-icon"
                 style="opacity: 0; transition: opacity 0.3s ease;"
                 onerror="this.style.display='none'; this.parentElement.classList.add('icon-failed');"
                 onload="this.style.opacity='1';">
             <div class="app-icon-fallback">${app.name.charAt(0).toUpperCase()}</div>`
              : `<div class="app-icon-emoji">${app.icon}</div>`
          }
        </div>
        <div class="app-name">${app.name}</div>
        ${app.plan === "exclusive" ? '<div class="exclusive-badge">💎</div>' : ""}
        <div class="app-favorite ${favorites.some((fav) => fav.id === app.id) ? "favorited" : ""}"
             onclick="event.stopPropagation(); toggleFavorite('${app.id}')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
          </svg>
        </div>
      </div>
    `,
    )
    .join("");

  // Add click listeners
  grid.querySelectorAll(".app-item").forEach((item) => {
    item.addEventListener("click", () => {
      const appId = item.dataset.appId;
      const app = availableApps.find((a) => a.id === appId);
      openApp(app);
    });
  });
}

// Render recent apps
function renderRecentApps() {
  const container = document.getElementById("recent-apps");

  if (!userAuthenticated) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">🔒</div>
        <h3>Login Required</h3>
        <p>Please login to view your recently used apps and access history.</p>
      </div>
    `;
    return;
  }

  const availableApps = getAvailableApps();
  const accessibleRecentApps = recentApps.filter((recentApp) =>
    availableApps.some((availableApp) => availableApp.id === recentApp.id),
  );

  if (accessibleRecentApps.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">🕒</div>
        <h3>No recent apps</h3>
        <p>Start using apps from the main tab to see your recently accessed applications here.</p>
      </div>
    `;
    return;
  }

  container.innerHTML = accessibleRecentApps
    .slice(0, 10)
    .map(
      (app) => `
      <div class="app-item" data-app-id="${app.id}">
        <div class="app-icon-container">
          ${
            app.icon && app.icon.startsWith("http")
              ? `<img src="${app.icon}"
                 alt="${app.name}"
                 class="app-icon"
                 style="opacity: 0; transition: opacity 0.3s ease;"
                 onerror="this.style.display='none'; this.parentElement.classList.add('icon-failed');"
                 onload="this.style.opacity='1';">
             <div class="app-icon-fallback">${app.name.charAt(0).toUpperCase()}</div>`
              : `<div class="app-icon-emoji">${app.icon || app.name.charAt(0).toUpperCase()}</div>`
          }
        </div>
        <div class="app-name">${app.name}</div>
      </div>
    `,
    )
    .join("");

  container.querySelectorAll(".app-item").forEach((item) => {
    item.addEventListener("click", () => {
      const appId = item.dataset.appId;
      const app = availableApps.find((a) => a.id === appId);
      openApp(app);
    });
  });
}

// Render favorite apps
function renderFavoriteApps() {
  const container = document.getElementById("favorites-apps");

  if (!userAuthenticated) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">🔒</div>
        <h3>Login Required</h3>
        <p>Please login to view and manage your favorite applications.</p>
      </div>
    `;
    return;
  }

  const availableApps = getAvailableApps();
  const accessibleFavorites = favorites.filter((favoriteApp) =>
    availableApps.some((availableApp) => availableApp.id === favoriteApp.id),
  );

  if (accessibleFavorites.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">⭐</div>
        <h3>No favorites yet</h3>
        <p>Mark your most-used apps as favorites for quick access. Click the star icon on any app to add it here.</p>
      </div>
    `;
    return;
  }

  container.innerHTML = accessibleFavorites
    .map(
      (app) => `
      <div class="app-item" data-app-id="${app.id}">
        <div class="app-icon-container">
          ${
            app.icon && app.icon.startsWith("http")
              ? `<img src="${app.icon}"
                 alt="${app.name}"
                 class="app-icon"
                 style="opacity: 0; transition: opacity 0.3s ease;"
                 onerror="this.style.display='none'; this.parentElement.classList.add('icon-failed');"
                 onload="this.style.opacity='1';">
             <div class="app-icon-fallback">${app.name.charAt(0).toUpperCase()}</div>`
              : `<div class="app-icon-emoji">${app.icon || app.name.charAt(0).toUpperCase()}</div>`
          }
        </div>
        <div class="app-name">${app.name}</div>
      </div>
    `,
    )
    .join("");

  container.querySelectorAll(".app-item").forEach((item) => {
    item.addEventListener("click", () => {
      const appId = item.dataset.appId;
      const app = availableApps.find((a) => a.id === appId);
      openApp(app);
    });
  });
}

// Open app
function openApp(app) {
  // Special handling for Netflix - show account selection
  if (app.id === "netflix" || app.id === "exclusive-netflix") {
    showNetflixAccounts(app);
    return;
  }

  // Add to recent apps
  const existingIndex = recentApps.findIndex((a) => a.id === app.id);
  if (existingIndex > -1) {
    recentApps.splice(existingIndex, 1);
  }
  recentApps.unshift({ ...app, lastUsed: new Date().toISOString() });
  recentApps = recentApps.slice(0, 20);

  // Save to storage
  chrome.storage.local.set({ recentApps });

  // Open in new tab
  chrome.tabs.create({ url: app.url });
  window.close();
}

// Show Netflix account selection modal
function showNetflixAccounts(app) {
  const modal = document.createElement("div");
  modal.className = "netflix-modal";
  modal.innerHTML = `
    <div class="netflix-modal-content">
      <div class="netflix-modal-header">
        <h3>Choose Netflix Account</h3>
        <button class="netflix-modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">×</button>
      </div>
      <div class="netflix-accounts">
        <div class="netflix-account" onclick="openNetflixAccount('https://netflix.com/account1')">
          <div class="netflix-account-icon">N1</div>
          <div class="netflix-account-info">
            <div class="netflix-account-name">Netflix Account 1</div>
            <div class="netflix-account-status">✅ Active</div>
          </div>
        </div>
        <div class="netflix-account" onclick="openNetflixAccount('https://netflix.com/account2')">
          <div class="netflix-account-icon">N2</div>
          <div class="netflix-account-info">
            <div class="netflix-account-name">Netflix Account 2</div>
            <div class="netflix-account-status">✅ Active</div>
          </div>
        </div>
        <div class="netflix-account" onclick="openNetflixAccount('https://netflix.com/account3')">
          <div class="netflix-account-icon">N3</div>
          <div class="netflix-account-info">
            <div class="netflix-account-name">Netflix Account 3</div>
            <div class="netflix-account-status">✅ Active</div>
          </div>
        </div>
      </div>
    </div>
    <div class="netflix-modal-backdrop" onclick="this.parentElement.remove()"></div>
  `;

  document.body.appendChild(modal);
}

// Open specific Netflix account
function openNetflixAccount(url) {
  // Add to recent apps
  const netflixApp = {
    id: "netflix",
    name: "Netflix",
    icon: "🎬",
    category: "streaming",
    lastUsed: new Date().toISOString(),
  };

  const existingIndex = recentApps.findIndex((a) => a.id === "netflix");
  if (existingIndex > -1) {
    recentApps.splice(existingIndex, 1);
  }
  recentApps.unshift(netflixApp);
  recentApps = recentApps.slice(0, 20);

  // Save to storage
  chrome.storage.local.set({ recentApps });

  // Remove modal
  document.querySelector(".netflix-modal")?.remove();

  // Open in new tab
  chrome.tabs.create({ url: url });
  window.close();
}

// Load storage data
async function loadStorageData() {
  try {
    const result = await chrome.storage.local.get(["recentApps", "favorites"]);
    recentApps = result.recentApps || [];
    favorites = result.favorites || [];
  } catch (error) {
    console.log("No storage data found");
  }
}

// Update stats
function updateStats() {
  const today = new Date().toDateString();
  const todayApps = recentApps.filter(
    (app) => new Date(app.lastUsed).toDateString() === today,
  );

  if (!userAuthenticated) {
    document.getElementById("total-apps").textContent = "0";
    document.getElementById("used-today").textContent = "0";
    document.getElementById("uptime").textContent = "00:00";
    updatePlanBadge("guest");
    return;
  }

  const availableApps = getAvailableApps();
  document.getElementById("total-apps").textContent =
    availableApps.length + "+";
  document.getElementById("used-today").textContent = todayApps.length;

  // Calculate uptime from when extension was first installed
  calculateAndDisplayUptime();
  updatePlanBadge(userPlan);
}

// Calculate and display uptime
async function calculateAndDisplayUptime() {
  try {
    const result = await chrome.storage.local.get(["installDate"]);
    let installDate = result.installDate;

    if (!installDate) {
      // If no install date, set it to now
      installDate = new Date().toISOString();
      chrome.storage.local.set({ installDate });
    }

    const install = new Date(installDate);
    const now = new Date();
    const diffMs = now - install;

    const hours = Math.floor(diffMs / (1000 * 60 * 60));
    const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

    const uptimeText =
      hours > 0
        ? `${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}`
        : `00:${minutes.toString().padStart(2, "0")}`;

    document.getElementById("uptime").textContent = uptimeText;
  } catch (error) {
    document.getElementById("uptime").textContent = "00:00";
  }
}

// Update plan badge
function updatePlanBadge(plan) {
  const planBadge = document.getElementById("plan-badge");
  const userBadge = document.getElementById("user-badge");

  if (!planBadge) return;

  // Remove existing plan classes
  planBadge.classList.remove("premium", "education", "exclusive");

  switch (plan) {
    case "premium":
      planBadge.textContent = "PREMIUM";
      planBadge.classList.add("premium");
      if (userBadge) userBadge.style.display = "flex";
      break;
    case "education":
      planBadge.textContent = "EDUCATION";
      planBadge.classList.add("education");
      if (userBadge) userBadge.style.display = "flex";
      break;
    case "exclusive":
      planBadge.textContent = "EXCLUSIVE";
      planBadge.classList.add("exclusive");
      if (userBadge) userBadge.style.display = "flex";
      break;
    case "guest":
    default:
      planBadge.textContent = "PREMIUM";
      planBadge.classList.add("premium");
      if (userBadge) userBadge.style.display = "flex";
      break;
  }
}

// Toggle favorite function
function toggleFavorite(appId) {
  const availableApps = getAvailableApps();
  const app = availableApps.find((a) => a.id === appId);
  if (!app) return;

  const existingIndex = favorites.findIndex((fav) => fav.id === appId);
  if (existingIndex > -1) {
    // Remove from favorites
    favorites.splice(existingIndex, 1);
  } else {
    // Add to favorites
    favorites.push(app);
  }

  // Save to storage
  chrome.storage.local.set({ favorites });

  // Re-render current tab to update star states
  const currentTabContent = document.querySelector(".tab-content.active");
  if (currentTabContent.id === "apps-content") {
    renderApps();
  } else if (currentTabContent.id === "favorites-content") {
    renderFavoriteApps();
  }
}

// WhatsApp Customer Support
function openWhatsAppSupport() {
  const phoneNumber = "6281234567890"; // Replace with actual customer service number
  const message = encodeURIComponent(
    "Halo! Saya memerlukan bantuan terkait KlixGenix.ID Extension. Mohon bantuannya.",
  );
  const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;

  // Open WhatsApp in new tab
  chrome.tabs.create({ url: whatsappUrl });

  // Optional: Close extension popup
  // window.close();
}

// Handle keyboard shortcuts
document.addEventListener("keydown", (e) => {
  if (e.key === "/" && e.target.tagName !== "INPUT") {
    e.preventDefault();
    document.getElementById("search-input").focus();
  }
});
